# Course Builder - Course Hierarchy Analysis

## ⚠️ FUNDAMENTAL PRINCIPLES (CRITICAL)

Before diving into the hierarchy details, understand these fundamental principles:

1. **Content Studio is the ONLY Content Source**
   - Course Builder NEVER creates lesson content
   - Course Builder NEVER generates educational content
   - Course Builder NEVER creates placeholder lessons
   - All lesson content (content_data, devlab_exercises) comes from Content Studio

2. **Topics and Modules are Structural Containers ONLY**
   - Topics and Modules contain NO actual content - EVER
   - They exist ONLY to maintain the hierarchy structure (Course → Topic → Module → Lesson)
   - They provide grouping and navigation in the UI
   - All real content lives at the Lesson level

3. **Course Builder is a Structuring Orchestrator**
   - Course Builder organizes content from Content Studio into the hierarchy
   - It never invents or generates content
   - For personalized courses: It extracts metadata from Learner AI and forwards context to Content Studio
   - Content Studio generates the lessons, then Course Builder structures them

4. **Personalized Courses are NOT "AI-Generated by Course Builder"**
   - Personalized courses come from: Learner AI → Course Builder → Content Studio → Course Builder
   - Course Builder forwards learner profile/skills to Content Studio
   - Content Studio generates personalized lessons
   - Course Builder structures the lessons (same as trainer courses)

5. **Identical Structure for All Courses**
   - Both Trainer courses and Personalized courses have identical DB structure
   - Both follow: Course → Topics → Modules → Lessons → Exercises
   - Topics/Modules are structural only (NO CONTENT) for all course types
   - All lesson content comes from Content Studio for all course types

---

## 1. Tree-Style Hierarchy

```
Course
  ├─ Topics (1:N) - STRUCTURAL CONTAINERS ONLY, NO CONTENT, NO SKILLS
  │    │
  │    └─ Modules (1:N) - STRUCTURAL CONTAINERS ONLY, NO CONTENT, NO SKILLS
  │         └─ Lessons (1:N) - REAL CONTENT LIVES HERE
  │              ├─ Skills (JSONB array) - stored on lessons.skills (from Content Studio)
  │              ├─ Content Data (JSONB array) - from Content Studio (lessons.content_data)
  │              ├─ DevLab Exercises (JSONB array) - from Content Studio (lessons.devlab_exercises)
  │              └─ Trainer IDs (UUID[]) - stored on lessons.trainer_ids
  │
  ├─ Exercises Table (1:N per lesson) - separate exercises table
  │
  ├─ JSONB Dictionaries (on Course)
  │    ├─ studentsIDDictionary (student progress)
  │    ├─ feedbackDictionary (learner feedback)
  │    └─ lesson_completion_dictionary (lesson completion tracking)
  │
  └─ learning_path_designation (JSONB on Course)
```

**❗ CRITICAL NOTES:**
- **Topics and Modules are STRUCTURAL CONTAINERS ONLY** - they do not contain actual content OR skills
- **All real content lives in Lessons** - content_data, devlab_exercises, skills, trainer_ids
- **Skills are ONLY stored at the Lesson level** - Topics do NOT store skills (even if the schema has a `topics.skills` field, it's not used for storing content)
- **Content Studio is the ONLY source of lesson content** - Course Builder never creates lesson content
- **Course Builder is a structuring orchestrator** - it organizes content from Content Studio into the hierarchy

---

## 2. Field-Level Hierarchy

### 2.1 Course Level

#### Mandatory Fields
- `id` (UUID) - Primary key
- `course_name` (TEXT) - Course title
- `course_type` (ENUM: 'learner_specific' | 'trainer') - Course type
- `status` (ENUM: 'active' | 'archived' | 'draft') - Course status
- `created_at` (TIMESTAMP) - Creation timestamp
- `updated_at` (TIMESTAMP) - Last update timestamp

#### Optional Fields
- `course_description` (TEXT) - Course description
- `level` (ENUM: 'beginner' | 'intermediate' | 'advanced') - Course difficulty level
- `duration_hours` (INT) - Estimated course duration
- `start_date` (TIMESTAMP) - Course start date
- `created_by_user_id` (UUID) - Creator user ID (trainer UUID, or learner UUID for personalized courses)

#### JSONB Fields (Stored on Course)
- `learning_path_designation` (JSONB) - Learning path metadata
  ```json
  {
    "is_designated": boolean,
    "target_competency": {
      "competency_id": UUID,
      "competency_name": string,
      "target_level": string,
      "max_test_attempts": number
    },
    "scheduled_publish_at": ISO8601 (optional)
  }
  ```
- `studentsIDDictionary` (JSONB) - Student progress tracking
  ```json
  {
    "student_id": {
      "status": "in_progress" | "completed" | "failed",
      "enrolled_date": ISO8601,
      "completed_date": ISO8601 | null,
      "completion_reason": string | null
    }
  }
  ```
- `feedbackDictionary` (JSONB) - Learner feedback
  ```json
  {
    "user_id": {
      "rating": number (1-5),
      "comment": string,
      "submitted_at": ISO8601
    }
  }
  ```
- `lesson_completion_dictionary` (JSONB) - Lesson completion tracking
  ```json
  {
    "lesson_id": {
      "topic_id": UUID,
      "topic_name": string,
      "trainer_ids": UUID[],
      "user_id": {
        "status": "completed" | "in_progress",
        "completed_at": ISO8601 | null
      }
    }
  }
  ```

#### Derived Fields (Not Stored in DB)
- `total_enrollments` - Calculated from `registrations` table
- `active_enrollments` - Calculated from `registrations` table (status='in_progress')
- `completed_enrollments` - Calculated from `registrations` table (status='completed')
- `completion_rate` - Calculated: (completed_enrollments / total_enrollments) * 100
- `rating` - Calculated: AVG(rating) from `feedback` table
- `average_rating` - Same as `rating`
- `skills` - Aggregated from all lessons: `lessons.flatMap(l => l.skills)` (Topics don't store skills)
- `version` - Latest version number from `versions` table
- `modules` - Aggregated structure from Topics → Modules → Lessons

---

### 2.2 Topic Level

#### Mandatory Fields
- `id` (UUID) - Primary key
- `course_id` (UUID) - Foreign key to `courses.id` (CASCADE DELETE)
- `topic_name` (TEXT) - Topic title

#### Optional Fields
- `topic_description` (TEXT) - Topic description

#### JSONB Fields
- `skills` (JSONB array) - **NOT USED FOR STORING CONTENT** - Topics are structural containers only
  - ⚠️ **Note**: Even though the schema has a `topics.skills` field, it is NOT used for storing actual skill content
  - Skills are ONLY stored at the Lesson level
  - Topics do NOT contain skills as content - they are structural containers only
  - If skills need to be aggregated from lessons, they are computed dynamically (derived field)

#### Derived Fields (Not Stored in DB)
- `modules` - Aggregated from `modules` table (topic_id)
- `lessons` - Aggregated through modules

#### ⚠️ CRITICAL: Topics as Structural Containers ONLY
- **Topics are ALWAYS structural/grouping containers ONLY** - for ALL course types (trainer and personalized)
- They exist to maintain the consistent Course → Topic → Module → Lesson hierarchy
- Topics do NOT hold raw learning content - EVER
- Topics do NOT store skills as content - Skills are ONLY at the Lesson level
- Topics primarily serve as high-level grouping names (e.g., "JavaScript Fundamentals – Track 1")
- **All actual learning content ALWAYS lives at the Lesson level** - including skills
- Course Builder never creates lesson content - Content Studio is the ONLY source

---

### 2.3 Module Level

#### Mandatory Fields
- `id` (UUID) - Primary key
- `topic_id` (UUID) - Foreign key to `topics.id` (CASCADE DELETE)
- `module_name` (TEXT) - Module title

#### Optional Fields
- `module_description` (TEXT) - Module description

#### Derived Fields (Not Stored in DB)
- `lessons` - Aggregated from `lessons` table (module_id)
- `topic_name` - Looked up from `topics` table
- `topic_id` - Direct reference

#### ⚠️ CRITICAL: Modules as Structural Containers ONLY
- **Modules are ALWAYS structural/grouping containers ONLY** - for ALL course types (trainer and personalized)
- They exist to maintain the consistent Course → Topic → Module → Lesson hierarchy
- Modules do NOT hold raw learning content - EVER
- Modules serve as sub-groupings under topics (e.g., "JS Basics")
- **All actual learning content ALWAYS lives at the Lesson level**
- Course Builder never creates lesson content - Content Studio is the ONLY source

---

### 2.4 Lesson Level

#### Mandatory Fields
- `id` (UUID) - Primary key
- `module_id` (UUID) - Foreign key to `modules.id` (CASCADE DELETE)
- `topic_id` (UUID) - Foreign key to `topics.id` (CASCADE DELETE)
- `lesson_name` (TEXT) - Lesson title

#### Optional Fields
- `lesson_description` (TEXT) - Lesson description
- `content_type` (TEXT) - Type of content: 'video' | 'article' | 'exercise' | 'mixed'
- `difficulty` - Not directly stored, but can be derived from exercises

#### JSONB Fields
- `skills` (JSONB array) - Skills associated with the lesson
  ```json
  ["react", "hooks", "useState"]
  ```
- `trainer_ids` (UUID[]) - Array of trainer UUIDs who contributed
- `content_data` (JSONB) - Raw content from Content Studio (array of content blocks)
  ```json
  [
    {
      "content_id": "C-001",
      "content_type": "text_audio",
      "content_data": {
        "text": "In this lesson, you will learn...",
        "audioUrl": "https://example.com/audio/lesson1.mp3",
        "audioVoice": "alloy",
        "audioFormat": "mp3",
        "audioDuration": 34.5
      }
    },
    {
      "content_id": "C-002",
      "content_type": "code",
      "content_data": {
        "language": "javascript",
        "code": "```javascript\nlet age = 20;\n...\n```",
        "explanation": "This example shows..."
      }
    },
    {
      "content_id": "C-003",
      "content_type": "presentation",
      "content_data": {
        "format": "pdf",
        "fileUrl": "https://example.com/presentations/variables.pdf",
        "fileName": "Variables and Data Types.pdf",
        "fileSize": 85000,
        "fileType": "application/pdf",
        "uploadedAt": "2025-11-11T13:22:49.587Z",
        "storagePath": "presentations/variables-lesson.pdf",
        "slide_count": 8
      }
    },
    {
      "content_id": "C-004",
      "content_type": "audio",
      "content_data": {
        "audioUrl": "https://example.com/audio/explanation.mp3",
        "audioVoice": "alloy",
        "audioFormat": "mp3",
        "audioDuration": 46.2,
        "script": "Today we explore..."
      }
    },
    {
      "content_id": "C-005",
      "content_type": "mind_map",
      "content_data": {
        "nodes": [
          { "id": "1", "type": "main", "label": "Data Types" },
          { "id": "2", "type": "detail", "label": "String" },
          { "id": "3", "type": "detail", "label": "Number" }
        ],
        "edges": [
          { "source": "1", "target": "2" },
          { "source": "1", "target": "3" }
        ]
      }
    },
    {
      "content_id": "C-006",
      "content_type": "avatar_video",
      "content_data": {
        "script": "Welcome to our short intro...",
        "videoId": "ed22fb03b54e4235a2395ed7b122a319",
        "videoUrl": "https://example.com/avatar/video123.mp4"
      }
    }
  ]
  ```
  
  **Important**: The entire `contents[]` array from Content Studio is stored as a **single JSONB array** in `lesson.content_data`. We do NOT split contents into multiple lesson rows. One Content Studio topic = one Course Builder lesson.
  
- `devlab_exercises` (JSONB array) - Exercises from DevLab
  ```json
  [
    {
      "exercise_id": UUID,
      "exercise_name": string,
      "exercise_type": string,
      "content": {}
    }
  ]
  ```
  
  **Important**: If Content Studio sends `devlab_exercises` as an empty string (`""`), it should be normalized to an empty array `[]`.

#### Derived Fields (Not Stored in DB)
- `exercises` - Aggregated from `exercises` table (lesson_id)
- `module_name` - Looked up from `modules` table
- `topic_name` - Looked up from `topics` table
- `course_id` - Looked up through module → topic → course

---

### 2.5 Exercise Level

#### Mandatory Fields
- `id` (UUID) - Primary key
- `lesson_id` (UUID) - Foreign key to `lessons.id` (CASCADE DELETE)
- `exercise_type` (TEXT) - Type of exercise

#### Optional Fields
- `difficulty` (ENUM: 'beginner' | 'intermediate' | 'advanced') - Exercise difficulty

#### JSONB Fields
- `content` (JSONB) - Exercise content
  ```json
  {
    "question": string,
    "options": string[],
    "correct_answer": string | number,
    "explanation": string,
    "hints": string[]
  }
  ```

#### Derived Fields (Not Stored in DB)
- `lesson_name` - Looked up from `lessons` table

---

## 3. Data Flow Through Hierarchy

### 3.1 Backend Flow: Controllers → Services → Repositories → DB

#### Request: GET /api/v1/courses/:id

```
1. Controller (courses.controller.js)
   ├─ Receives: courseId, learnerId (optional), role
   ├─ Validates: courseId exists
   └─ Calls: coursesService.getCourseDetails(courseId, options)

2. Service (courses.service.js)
   ├─ Calls: courseRepository.findById(courseId)
   ├─ Calls: topicRepository.findByCourseId(courseId)
   ├─ For each topic:
   │    ├─ Calls: moduleRepository.findByTopicId(topic.id)
   │    └─ For each module:
   │         └─ Calls: lessonRepository.findByModuleId(module.id)
   ├─ Calls: versionRepository.findLatestVersion('course', courseId)
   ├─ Calculates derived fields:
   │    ├─ rating (AVG from feedback table)
   │    ├─ total_enrollments (COUNT from registrations)
   │    ├─ active_enrollments (COUNT from registrations WHERE status='in_progress')
   │    ├─ completed_enrollments (COUNT from registrations WHERE status='completed')
   │    ├─ completion_rate (calculated percentage)
   │    └─ learner_progress (if learnerId provided)
   └─ Returns: Aggregated course structure

3. Repository (CourseRepository.js, TopicRepository.js, etc.)
   ├─ Executes: SQL queries against PostgreSQL
   ├─ Maps: Database rows to Model instances
   └─ Returns: Model objects (Course, Topic, Module, Lesson)

4. Database (PostgreSQL)
   ├─ Queries: courses, topics, modules, lessons, exercises tables
   ├─ Joins: Topics → Modules → Lessons → Exercises
   └─ Returns: Raw database rows
```

#### Request: POST /api/v1/courses/:id/progress

```
1. Controller (courses.controller.js)
   ├─ Receives: courseId, learnerId, lessonId, completed
   └─ Calls: coursesService.updateLessonProgress(courseId, {learnerId, lessonId, completed})

2. Service (courses.service.js)
   ├─ Validates: Course exists, Registration exists, Lesson exists, Lesson belongs to course
   ├─ Updates: lesson_completion_dictionary (JSONB on Course)
   ├─ Calculates: Progress percentage from completed lessons
   ├─ Updates: Registration status (if progress = 100%)
   ├─ Updates: studentsIDDictionary (JSONB on Course)
   └─ Returns: Updated progress data

3. Repository (CourseRepository.js)
   ├─ Updates: courses.lesson_completion_dictionary (JSONB)
   ├─ Updates: courses.studentsIDDictionary (JSONB)
   └─ Returns: Updated Course model

4. Database (PostgreSQL)
   ├─ Updates: courses table (JSONB fields)
   ├─ Updates: registrations table (status, completed_date)
   └─ Returns: Updated rows
```

### 3.2 Frontend Delivery Flow

#### API Response Structure

```
GET /api/v1/courses/:id
Response:
{
  "id": UUID,
  "title": string,
  "description": string,
  "level": "beginner" | "intermediate" | "advanced",
  "status": "active" | "archived" | "draft",
  "duration": number,
  "total_enrollments": number,
  "active_enrollments": number,
  "completion_rate": number,
  "rating": number,
  "created_at": ISO8601,
  "updated_at": ISO8601,
  "modules": [
    {
      "id": UUID,
      "title": string,
      "description": string,
      "topic_id": UUID,
      "topic_name": string,
      "lessons": [
        {
          "id": UUID,
          "title": string,
          "description": string,
          "content_type": string,
          "skills": string[]
        }
      ]
    }
  ],
  "skills": string[],
  "version": string,
  "learner_progress": {
    "is_enrolled": boolean,
    "registration_id": UUID,
    "progress": number,
    "status": "in_progress" | "completed",
    "completed_lessons": UUID[]
  }
}
```

#### Frontend Consumption (apiService.js → React Components)

```
1. Frontend API Service (apiService.js)
   ├─ Calls: GET /api/v1/courses/:id
   ├─ Adds: Headers (X-User-Role, X-User-Id)
   └─ Returns: Course data

2. React Components
   ├─ CourseDetailsPage.jsx
   │    ├─ Displays: Course metadata, modules, lessons
   │    └─ Uses: CourseStructure component
   ├─ CourseStructurePage.jsx
   │    ├─ Displays: Full hierarchy (Topics → Modules → Lessons)
   │    └─ Uses: CourseTreeView component
   ├─ LessonPage.jsx
   │    ├─ Displays: Individual lesson content
   │    └─ Uses: LessonViewer component
   └─ CourseTreeView.jsx
        ├─ Renders: Nested tree structure
        └─ Handles: Navigation to lessons
```

---

## 3.5 Content Studio Data Mapping

### 3.5.1 Content Studio Structure Mapping

**Content Studio sends** (example structure):
```json
{
  "course_id": "COURSE-001",
  "course_name": "JavaScript Fundamentals",
  "course_description": "A complete beginner-friendly course...",
  "course_language": "en",
  "trainer_id": "TR-555",
  "trainer_name": "Maya Levi",
  "topics": [
    {
      "topic_id": "T-101",
      "topic_name": "Variables & Data Types",
      "topic_description": "Understanding how JavaScript stores...",
      "topic_language": "en",
      "template_id": "TMP-001",
      "format_order": ["text_audio", "code", "presentation", "audio", "mind_map", "avatar_video"],
      "contents": [
        {
          "content_id": "C-001",
          "content_type": "text_audio",
          "content_data": { ... }
        },
        // ... more content blocks
      ],
      "devlab_exercises": "" // or array of exercises
    }
  ]
}
```

**Course Builder storage mapping**:

| Content Studio Field | Course Builder Storage | Notes |
|---------------------|------------------------|-------|
| `course_id`, `course_name`, `course_description` | `courses` table | One course row |
| `trainer_id`, `trainer_name` | `courses.created_by_user_id`, stored separately | Trainer metadata |
| `topics[]` (each topic) | **One `lesson` row** | **Content Studio topic becomes a Lesson** |
| `topics[].topic_name` | `lessons.lesson_name` | Topic name becomes lesson name |
| `topics[].topic_description` | `lessons.lesson_description` | Topic description becomes lesson description |
| `topics[].contents[]` | `lessons.content_data` (JSONB array) | **Entire contents array stored as single JSONB** |
| `topics[].devlab_exercises` | `lessons.devlab_exercises` (JSONB array) | Normalize empty string `""` to `[]` |
| Structural containers | `topics` and `modules` tables | Created for hierarchy, no content stored |

### 3.5.2 Key Mapping Rules

1. **One Content Studio Topic = One Course Builder Lesson**
   - Each Content Studio `topic` object becomes a single `lesson` row in the `lessons` table
   - The `contents[]` array is stored as a whole in `lesson.content_data` (JSONB)
   - We do NOT split `contents[]` into multiple lesson rows

2. **Topics and Modules as Structural Containers**
   - For Content Studio courses, Course Builder still maintains: `Course → Topic → Module → Lesson`
   - Topics and Modules are created as **structural/grouping containers only**
   - They exist to maintain the consistent hierarchy and UI navigation
   - **Topic**: High-level grouping name (e.g., "JavaScript Fundamentals – Track 1")
   - **Module**: Sub-grouping under that topic (e.g., "JS Basics")
   - **Lesson**: The actual Content Studio topic (the real learning unit with content)

3. **Content Storage**
   - All raw content (text/audio/code/presentation/mind_map/avatar_video) lives in the `lesson` record only
   - `lesson.content_data` contains the entire `contents[]` array from Content Studio
   - Topics/modules are there for structure, navigation, and UI – not for storing content

4. **devlab_exercises Normalization**
   - If Content Studio sends `devlab_exercises` as an empty string (`""`), normalize it to an empty array `[]`
   - Store as JSONB array in `lessons.devlab_exercises`

### 3.5.3 Content Studio Workflows

#### A. Trainer Course Flow

```
1. Trainer uploads content → Content Studio
   └─ Trainer creates course content in Content Studio

2. Content Studio generates lessons
   ├─ Creates: Course metadata
   ├─ Generates: Topics with full content (contents[], devlab_exercises)
   └─ Sends: Full course data via POST /api/v1/integrations
       └─ x-source-service: content_studio

3. Course Builder receives Content Studio data
   ├─ Integration Controller (integration.controller.js)
   │    ├─ Receives: Content Studio payload
   │    ├─ Validates: Service header and payload structure
   │    └─ Calls: contentStudio.service.handleContentData(payload)
   │
   └─ Content Studio Service (contentStudio.service.js)
       ├─ Creates: Course in courses table
       ├─ Creates: Topic and Module (structural containers ONLY)
       ├─ For each Content Studio topic:
       │    ├─ Creates: One Lesson in lessons table
       │    ├─ Stores: topic.contents[] → lesson.content_data (JSONB array)
       │    ├─ Stores: topic.devlab_exercises → lesson.devlab_exercises (JSONB array)
       │    └─ Stores: topic.topic_name → lesson.lesson_name
       └─ Returns: Import confirmation

4. Database Storage
   ├─ courses table: Course metadata
   ├─ topics table: Structural container (name only, NO CONTENT)
   ├─ modules table: Structural container (name only, NO CONTENT)
   ├─ lessons table: Actual content from Content Studio
   │    ├─ content_data: Full contents[] array (JSONB)
   │    └─ devlab_exercises: Exercises array (JSONB)
   └─ Result: Course → Topic → Module → Lesson hierarchy maintained
```

#### B. Personalized Course Flow (Learner AI → Content Studio)

```
1. Learner AI sends request → Course Builder
   ├─ Learner profile (learner_id, learner_name, company_id)
   ├─ Skills array
   ├─ Learning path designation
   └─ Target competency

2. Course Builder processes request
   ├─ Does NOT create placeholder lessons
   ├─ Does NOT generate any educational content
   ├─ Extracts: Relevant metadata (skills, competency, learner context)
   └─ Forwards: Context to Content Studio
       └─ Request: Generate personalized course based on learner profile

3. Content Studio generates personalized course
   ├─ Receives: Learner profile + skills + learning path from Course Builder
   ├─ Generates: REAL lessons (content_data, exercises, etc.)
   │    ├─ Creates: Course metadata
   │    ├─ Generates: Topics with full content (contents[], devlab_exercises)
   │    └─ Personalizes: Content based on learner profile and skills
   └─ Sends: Full course data back to Course Builder
       └─ POST /api/v1/integrations (x-source-service: content_studio)

4. Course Builder receives Content Studio data
   ├─ Integration Controller (integration.controller.js)
   │    ├─ Receives: Content Studio payload (same as Trainer flow)
   │    ├─ Validates: Service header and payload structure
   │    └─ Calls: contentStudio.service.handleContentData(payload)
   │
   └─ Content Studio Service (contentStudio.service.js)
       ├─ Creates: Course in courses table
       ├─ Creates: Topic and Module (structural containers ONLY)
       ├─ For each Content Studio topic:
       │    ├─ Creates: One Lesson in lessons table
       │    ├─ Stores: topic.contents[] → lesson.content_data (JSONB array)
       │    ├─ Stores: topic.devlab_exercises → lesson.devlab_exercises (JSONB array)
       │    └─ Stores: topic.topic_name → lesson.lesson_name
       └─ Returns: Import confirmation

5. Database Storage (IDENTICAL to Trainer flow)
   ├─ courses table: Course metadata
   ├─ topics table: Structural container (name only, NO CONTENT)
   ├─ modules table: Structural container (name only, NO CONTENT)
   ├─ lessons table: Actual content from Content Studio
   │    ├─ content_data: Full contents[] array (JSONB)
   │    └─ devlab_exercises: Exercises array (JSONB)
   └─ Result: Course → Topic → Module → Lesson hierarchy maintained
```

**❗ KEY POINTS:**
- **Course Builder NEVER creates lesson content** - Content Studio is the ONLY source
- **Both flows (Trainer and Personalized) result in identical DB structure**
- **Topics and Modules are ALWAYS structural containers only** - no content stored
- **All lesson content comes from Content Studio** - stored in `lessons.content_data` and `lessons.devlab_exercises`

---

## 4. External Service Dependencies

### 4.1 Learning Analytics

#### Data Sent to Learning Analytics
- **Endpoint**: Internal service call (via analytics.service.js)
- **Payload**: Built by `learningAnalyticsDTO.js`
- **Structure**: Array of courses with **FLATTENED hierarchy** (Topics/Modules are NOT sent - only Lessons)
  ```json
  {
    "courses": [
      {
        "course_id": UUID,
        "course_name": string,
        "course_type": "learner_specific" | "trainer",
        "created_by_user_id": UUID,
        "duration_hours": number,
        "created_at": ISO8601,
        "updated_at": ISO8601,
        "learning_path_designation": {
          "is_designated": boolean,
          "learning_path_id": UUID | null,
          "learning_path_name": string | null
        },
        "structure": {
          "total_lessons": number,
          "lessons": [
            {
              "lesson_id": UUID,
              "lesson_name": string,
              "lesson_order": number,
              "content": [
                {
                  "content_id": string,
                  "content_name": string,
                  "content_type": "text_audio" | "code" | "presentation" | "audio" | "mind_map" | "avatar_video",
                  "topic_name": string,
                  "content_generator": string,
                  "total_usage_count": number,
                  "duration_minutes": number,
                  "trainer_id": UUID | null
                }
              ]
            }
          ]
        },
        "studentsIDDictionary": {
          "learner_id": {
            "enrolled_at": ISO8601,
            "completed_at": ISO8601 | null,
            "failed_at": ISO8601 | null
          }
        },
        "lesson_completion_dictionary": {
          "lesson_id": {
            "completions": {
              "learner_id": {
                "started_at": ISO8601,
                "completed_at": ISO8601
              }
            }
          }
        },
        "feedback": {
          "total_feedback": number,
          "average_rating": number,
          "feedbacks": [
            {
              "learner_id": UUID,
              "rating": number,
              "comment": string,
              "submitted_at": ISO8601
            }
          ]
        },
        "assessments": {
          "total_assessments": number,
          "passed_count": number,
          "average_grade": number
        }
      }
    ]
  }
  ```
- **Source**: 
  - Course data from `courses` table
  - **Structure is FLATTENED** - Topics/Modules hierarchy is flattened to Course → Lessons
  - `structure.lessons` comes from `lessons` table
  - `structure.lessons[].content` comes from `lessons.content_data` (JSONB array from Content Studio)
  - `topic_name` in content items refers to the topic (structural container) the lesson belongs to
  - `studentsIDDictionary` from `courses.studentsIDDictionary` (JSONB)
  - `lesson_completion_dictionary` from `courses.lesson_completion_dictionary` (JSONB)
  - `learning_path_designation` from `courses.learning_path_designation` (JSONB)
  - Enrollment statistics from `registrations` table (aggregated)
  - Feedback from `feedback` table (aggregated)
  - Assessments from `assessments` table (aggregated)
- **Key Points**:
  - **Topics/Modules hierarchy is FLATTENED** - Learning Analytics receives Course → Lessons structure
  - Topics and Modules are NOT sent to Learning Analytics (they're structural containers only)
  - Each lesson's `content` array comes from `lesson.content_data` (Content Studio `contents[]` array)
  - `topic_name` in content items references the structural topic container name for context
  - Content items include metadata like `content_generator`, `total_usage_count`, `duration_minutes`
  - All lesson content comes from Content Studio (stored in `lessons.content_data`)
- **Dependency**: Learning Analytics receives flattened course structure (Course → Lessons) for analytics. The Topics/Modules hierarchy is flattened - Topics/Modules are structural containers only and are not sent to Learning Analytics.

### 4.2 Content Studio

#### Data Received from Content Studio
- **Endpoint**: POST /api/v1/integrations (x-source-service: content_studio)
- **Payload**: Built by `contentStudioDTO.js`
- **Structure**:
  ```json
  {
    "course_id": "COURSE-001",
    "course_name": "JavaScript Fundamentals",
    "course_description": "A complete beginner-friendly course...",
    "course_language": "en",
    "trainer_id": "TR-555",
    "trainer_name": "Maya Levi",
    "topics": [
      {
        "topic_id": "T-101",
        "topic_name": "Variables & Data Types",
        "topic_description": "Understanding how JavaScript stores...",
        "topic_language": "en",
        "template_id": "TMP-001",
        "format_order": ["text_audio", "code", "presentation", "audio", "mind_map", "avatar_video"],
        "contents": [
          {
            "content_id": "C-001",
            "content_type": "text_audio",
            "content_data": {
              "text": "...",
              "audioUrl": "...",
              "audioVoice": "alloy",
              "audioFormat": "mp3",
              "audioDuration": 34.5
            }
          },
          // ... more content blocks (code, presentation, audio, mind_map, avatar_video)
        ],
        "devlab_exercises": "" // or array
      }
      // ... more topics
    ]
  }
  ```
- **Storage Mapping**: 
  - **Content Studio course** → `courses` table (one row)
  - **Content Studio topic** → `lessons` table (one lesson per Content Studio topic)
  - **Content Studio contents[]** → `lessons.content_data` (JSONB array - entire contents array stored in single field)
  - **Content Studio devlab_exercises** → `lessons.devlab_exercises` (JSONB array, normalize empty string to `[]`)
  - **Structural containers** → `topics` and `modules` tables (created for hierarchy, no content stored)
- **Key Points**:
  - One Content Studio topic = one Course Builder lesson
  - The entire `contents[]` array is stored as a single JSONB array in `lesson.content_data`
  - Topics and Modules are structural containers (grouping/navigation) for Content Studio courses
  - All actual learning content lives at the Lesson level
- **Dependency**: Content Studio provides the lesson content that populates the `lessons.content_data` JSONB field and `lessons.devlab_exercises` JSONB array.

#### Data Sent to Content Studio (for Personalized Courses)
- **Endpoint**: Internal service call (via contentStudio.service.js)
- **Payload**: 
  ```json
  {
    "learner_id": UUID,
    "learner_name": string,
    "learner_company": string (optional),
    "company_id": UUID (optional),
    "skills": string[],
    "learning_path_designation": {
      "target_competency": {
        "competency_id": UUID,
        "competency_name": string,
        "target_level": string
      }
    }
  }
  ```
- **Purpose**: Request personalized content generation based on learner profile and skills
- **Workflow**: 
  1. Learner AI sends learner profile + skills → Course Builder
  2. Course Builder extracts metadata and forwards context to Content Studio
  3. Content Studio generates personalized lessons and sends back to Course Builder
  4. Course Builder structures lessons into Topics → Modules → Lessons and stores in DB
- **Dependency**: Course Builder forwards learner context to Content Studio for personalized course generation. Course Builder NEVER generates lesson content itself.

### 4.3 Assessment Microservice

#### Data Sent to Assessment
- **Endpoint**: Internal service call (via assessment.service.js)
- **Payload**: Built by `assessmentDTO.js`
- **Structure**:
  ```json
  {
    "learner_id": UUID,
    "learner_name": string,
    "course_id": UUID,
    "course_name": string,
    "coverage_map": [
      {
        "lesson_id": UUID,
        "skills": string[]
      }
    ]
  }
  ```
- **Source**: 
  - `learner_id`, `learner_name` from `registrations` table
  - `course_id`, `course_name` from `courses` table
  - `coverage_map` derived from `lessons` table (aggregated by course)
- **Dependency**: Assessment depends on the lesson hierarchy to build coverage maps (lesson_id → skills) for exam generation.

#### Data Received from Assessment
- **Endpoint**: POST /api/v1/integrations (x-source-service: assessment)
- **Payload**: 
  ```json
  {
    "learner_id": UUID,
    "course_id": UUID,
    "course_name": string,
    "exam_type": "postcourse",
    "passing_grade": number,
    "final_grade": number,
    "passed": boolean
  }
  ```
- **Storage**: Stored in `assessments` table
- **Dependency**: Assessment results are linked to courses and used in Learning Analytics payloads.

---

## 5. Minimal Example JSON Course Structure

### 5.1 Personalized Course Example (from Learner AI → Content Studio)

**⚠️ IMPORTANT:** This is a personalized course. Course Builder does NOT generate lesson content. The workflow is:
1. Learner AI sends learner profile + skills + learning path → Course Builder
2. Course Builder extracts metadata and forwards context to Content Studio
3. Content Studio generates the REAL lessons (content_data, exercises, etc.)
4. Content Studio sends full lessons array back → Course Builder
5. Course Builder wraps lessons in Topics → Modules structure and stores in DB

```json
{
  "id": "11111111-1111-1111-1111-111111111111",
  "title": "Introduction to React",
  "description": "Learn the basics of React",
  "level": "beginner",
  "status": "active",
  "duration": 10,
  "total_enrollments": 0,
  "active_enrollments": 0,
  "completion_rate": 0,
  "rating": 0,
  "created_at": "2025-01-01T00:00:00Z",
  "updated_at": "2025-01-01T00:00:00Z",
  "modules": [
    {
      "id": "22222222-2222-2222-2222-222222222222",
      "title": "React Fundamentals",
      "description": "Core React concepts",
      "topic_id": "33333333-3333-3333-3333-333333333333",
      "topic_name": "React Basics",
      "lessons": [
        {
          "id": "44444444-4444-4444-4444-444444444444",
          "title": "Components and JSX",
          "description": "Introduction to React components",
          "content_type": "video",
          "skills": ["react", "jsx", "components"]
        }
      ]
    }
  ],
  "skills": ["react", "jsx", "components"],
  "version": "1"
}
```

### 5.2 Content Studio Course Example (Minimal)

```json
{
  "id": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",
  "title": "JavaScript Fundamentals",
  "description": "A complete beginner-friendly course covering the basics of JavaScript.",
  "level": "beginner",
  "status": "draft",
  "duration": 20,
  "total_enrollments": 0,
  "active_enrollments": 0,
  "completion_rate": 0,
  "rating": 0,
  "created_at": "2025-01-01T00:00:00Z",
  "updated_at": "2025-01-01T00:00:00Z",
  "created_by_user_id": "TR-555",
  "modules": [
    {
      "id": "bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb",
      "title": "JS Basics",
      "description": "JavaScript Fundamentals - Track 1",
      "topic_id": "cccccccc-cccc-cccc-cccc-cccccccccccc",
      "topic_name": "JavaScript Fundamentals – Track 1",
      "lessons": [
        {
          "id": "dddddddd-dddd-dddd-dddd-dddddddddddd",
          "title": "Variables & Data Types",
          "description": "Understanding how JavaScript stores and represents information.",
          "content_type": "mixed",
          "skills": ["javascript", "variables", "data-types"],
          "content_data": [
            {
              "content_id": "C-001",
              "content_type": "text_audio",
              "content_data": {
                "text": "In this lesson, you will learn what variables are...",
                "audioUrl": "https://example.com/audio/lesson1.mp3",
                "audioVoice": "alloy",
                "audioFormat": "mp3",
                "audioDuration": 34.5
              }
            },
            {
              "content_id": "C-002",
              "content_type": "code",
              "content_data": {
                "language": "javascript",
                "code": "```javascript\nlet age = 20;\nconst name = \"Sara\";\nconsole.log(age, name);\n```",
                "explanation": "This example shows simple variable declarations..."
              }
            }
          ],
          "devlab_exercises": []
        }
      ]
    }
  ],
  "skills": ["javascript", "variables", "data-types"],
  "version": "1"
}
```

---

## 6. Full Example JSON Course Structure

### 6.1 Personalized Course Example (Full - from Learner AI → Content Studio)

**⚠️ IMPORTANT:** This is a personalized course. All lesson content comes from Content Studio, not Course Builder.

```json
{
  "id": "11111111-1111-1111-1111-111111111111",
  "title": "Advanced React Development",
  "description": "Master advanced React patterns and best practices",
  "level": "advanced",
  "status": "active",
  "duration": 40,
  "total_enrollments": 150,
  "active_enrollments": 75,
  "completion_rate": 50.0,
  "rating": 4.6,
  "created_at": "2025-01-01T00:00:00Z",
  "updated_at": "2025-11-13T10:00:00Z",
  "created_by_user_id": "20000000-0000-0000-0000-000000000001",
  "modules": [
    {
      "id": "22222222-2222-2222-2222-222222222222",
      "title": "React Hooks",
      "description": "Deep dive into React Hooks",
      "topic_id": "33333333-3333-3333-3333-333333333333",
      "topic_name": "State Management",
      "lessons": [
        {
          "id": "44444444-4444-4444-4444-444444444444",
          "title": "useState and useEffect",
          "description": "Master the most common React hooks",
          "content_type": "mixed",
          "skills": ["react", "hooks", "useState", "useEffect"]
        },
        {
          "id": "55555555-5555-5555-5555-555555555555",
          "title": "Custom Hooks",
          "description": "Create reusable custom hooks",
          "content_type": "article",
          "skills": ["react", "hooks", "custom-hooks"]
        }
      ]
    },
    {
      "id": "66666666-6666-6666-6666-666666666666",
      "title": "Context API",
      "description": "Manage global state with Context",
      "topic_id": "77777777-7777-7777-7777-777777777777",
      "topic_name": "State Management",
      "lessons": [
        {
          "id": "88888888-8888-8888-8888-888888888888",
          "title": "Creating Context",
          "description": "Set up React Context",
          "content_type": "video",
          "skills": ["react", "context", "state-management"]
        },
        {
          "id": "99999999-9999-9999-9999-999999999999",
          "title": "Context Best Practices",
          "description": "Optimize Context usage",
          "content_type": "article",
          "skills": ["react", "context", "optimization"]
        }
      ]
    },
    {
      "id": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",
      "title": "Performance Optimization",
      "description": "Optimize React applications",
      "topic_id": "bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb",
      "topic_name": "Performance",
      "lessons": [
        {
          "id": "cccccccc-cccc-cccc-cccc-cccccccccccc",
          "title": "React.memo and useMemo",
          "description": "Memoization techniques",
          "content_type": "mixed",
          "skills": ["react", "performance", "memoization"]
        },
        {
          "id": "dddddddd-dddd-dddd-dddd-dddddddddddd",
          "title": "Code Splitting",
          "description": "Split code for better performance",
          "content_type": "article",
          "skills": ["react", "performance", "code-splitting"]
        }
      ]
    }
  ],
  "skills": [
    "react",
    "hooks",
    "useState",
    "useEffect",
    "custom-hooks",
    "context",
    "state-management",
    "optimization",
    "performance",
    "memoization",
    "code-splitting"
  ],
  "version": "3",
  "learner_progress": {
    "is_enrolled": true,
    "registration_id": "eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee",
    "progress": 66.67,
    "status": "in_progress",
    "completed_lessons": [
      "44444444-4444-4444-4444-444444444444",
      "55555555-5555-5555-5555-555555555555",
      "88888888-8888-8888-8888-888888888888"
    ]
  }
}
```

### 6.2 Content Studio Course Example (Full)

```json
{
  "id": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",
  "title": "JavaScript Fundamentals",
  "description": "A complete beginner-friendly course covering the basics of JavaScript.",
  "level": "beginner",
  "status": "draft",
  "duration": 20,
  "total_enrollments": 0,
  "active_enrollments": 0,
  "completion_rate": 0,
  "rating": 0,
  "created_at": "2025-01-01T00:00:00Z",
  "updated_at": "2025-01-01T00:00:00Z",
  "created_by_user_id": "TR-555",
  "modules": [
    {
      "id": "bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb",
      "title": "JS Basics",
      "description": "JavaScript Fundamentals - Track 1",
      "topic_id": "cccccccc-cccc-cccc-cccc-cccccccccccc",
      "topic_name": "JavaScript Fundamentals – Track 1",
      "lessons": [
        {
          "id": "dddddddd-dddd-dddd-dddd-dddddddddddd",
          "title": "Variables & Data Types",
          "description": "Understanding how JavaScript stores and represents information.",
          "content_type": "mixed",
          "skills": ["javascript", "variables", "data-types"],
          "content_data": [
            {
              "content_id": "C-001",
              "content_type": "text_audio",
              "content_data": {
                "text": "In this lesson, you will learn what variables are and how JavaScript stores different types of data.",
                "audioUrl": "https://example.com/audio/lesson1.mp3",
                "audioVoice": "alloy",
                "audioFormat": "mp3",
                "audioDuration": 34.5
              }
            },
            {
              "content_id": "C-002",
              "content_type": "code",
              "content_data": {
                "language": "javascript",
                "code": "```javascript\nlet age = 20;\nconst name = \"Sara\";\nconsole.log(age, name);\n```",
                "explanation": "This example shows simple variable declarations using let and const."
              }
            },
            {
              "content_id": "C-003",
              "content_type": "presentation",
              "content_data": {
                "format": "pdf",
                "fileUrl": "https://example.com/presentations/variables.pdf",
                "fileName": "Variables and Data Types.pdf",
                "fileSize": 85000,
                "fileType": "application/pdf",
                "uploadedAt": "2025-11-11T13:22:49.587Z",
                "storagePath": "presentations/variables-lesson.pdf",
                "slide_count": 8
              }
            },
            {
              "content_id": "C-004",
              "content_type": "audio",
              "content_data": {
                "audioUrl": "https://example.com/audio/explanation.mp3",
                "audioVoice": "alloy",
                "audioFormat": "mp3",
                "audioDuration": 46.2,
                "script": "Today we explore how JavaScript handles different kinds of values."
              }
            },
            {
              "content_id": "C-005",
              "content_type": "mind_map",
              "content_data": {
                "nodes": [
                  { "id": "1", "type": "main", "label": "Data Types" },
                  { "id": "2", "type": "detail", "label": "String" },
                  { "id": "3", "type": "detail", "label": "Number" }
                ],
                "edges": [
                  { "source": "1", "target": "2" },
                  { "source": "1", "target": "3" }
                ]
              }
            },
            {
              "content_id": "C-006",
              "content_type": "avatar_video",
              "content_data": {
                "script": "Welcome to our short intro on JavaScript variables.",
                "videoId": "ed22fb03b54e4235a2395ed7b122a319",
                "videoUrl": "https://example.com/avatar/video123.mp4"
              }
            }
          ],
          "devlab_exercises": []
        },
        {
          "id": "eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee",
          "title": "Functions & Scope",
          "description": "Understanding JavaScript functions and variable scope.",
          "content_type": "mixed",
          "skills": ["javascript", "functions", "scope"],
          "content_data": [
            {
              "content_id": "C-101",
              "content_type": "text_audio",
              "content_data": {
                "text": "Functions are fundamental building blocks in JavaScript...",
                "audioUrl": "https://example.com/audio/lesson2.mp3",
                "audioVoice": "alloy",
                "audioFormat": "mp3",
                "audioDuration": 42.0
              }
            },
            {
              "content_id": "C-102",
              "content_type": "code",
              "content_data": {
                "language": "javascript",
                "code": "```javascript\nfunction greet(name) {\n  return `Hello, ${name}!`;\n}\nconsole.log(greet('World'));\n```",
                "explanation": "This example demonstrates a simple function declaration."
              }
            }
          ],
          "devlab_exercises": [
            {
              "exercise_id": "EX-001",
              "exercise_name": "Create a Function",
              "exercise_type": "coding",
              "content": {
                "question": "Write a function that adds two numbers",
                "hints": ["Use the function keyword", "Return the sum"],
                "solution": "function add(a, b) { return a + b; }"
              }
            }
          ]
        }
      ]
    }
  ],
  "skills": ["javascript", "variables", "data-types", "functions", "scope"],
  "version": "1"
}
```

---

## 7. Database Relationships Summary

### Cascade Rules
- **Course → Topics**: `ON DELETE CASCADE` - Deleting a course deletes all topics
- **Topic → Modules**: `ON DELETE CASCADE` - Deleting a topic deletes all modules
- **Module → Lessons**: `ON DELETE CASCADE` - Deleting a module deletes all lessons
- **Lesson → Exercises**: `ON DELETE CASCADE` - Deleting a lesson deletes all exercises

### Foreign Key Constraints
- `topics.course_id` → `courses.id`
- `modules.topic_id` → `topics.id`
- `lessons.module_id` → `modules.id`
- `lessons.topic_id` → `topics.id` (dual reference for performance)
- `exercises.lesson_id` → `lessons.id`

### Indexes
- `idx_topics_course_id` - Fast topic lookup by course
- `idx_modules_topic_id` - Fast module lookup by topic
- `idx_lessons_module_id` - Fast lesson lookup by module
- `idx_lessons_topic_id` - Fast lesson lookup by topic
- `idx_exercises_lesson_id` - Fast exercise lookup by lesson
- `idx_lessons_trainer_ids` - GIN index for trainer_ids array search

---

## 8. Key Implementation Details

### 8.1 JSONB Fields Usage
- **learning_path_designation**: Stores learning path metadata (optional, from Learner AI for personalized courses)
- **studentsIDDictionary**: Tracks student progress without separate table joins
- **feedbackDictionary**: Stores feedback without separate table (also stored in `feedback` table for queries)
- **lesson_completion_dictionary**: Tracks lesson completion per user (nested structure)
- **skills** (on Lesson ONLY): Array of skill strings for skill-based queries
  - ⚠️ **Topics do NOT store skills** - Topics are structural containers only
  - Lessons: Skills associated with the lesson (from Content Studio)
  - If topic-level skills are needed, they are computed dynamically by aggregating from lessons (derived field)
- **content_data** (on Lesson): Raw content from Content Studio (entire `contents[]` array stored as JSONB array)
  - **Content Studio is the ONLY source** - Course Builder NEVER generates this
  - Contains all content blocks from Content Studio (text_audio, code, presentation, audio, mind_map, avatar_video)
  - One Content Studio topic's `contents[]` array = one `lesson.content_data` JSONB array
  - We do NOT split contents into multiple lessons
  - Course Builder stores this as-is from Content Studio - never modifies or generates it
- **devlab_exercises** (on Lesson): Exercises from Content Studio/DevLab integration (JSONB array)
  - **Content Studio is the ONLY source** - Course Builder NEVER generates this
  - Normalize empty string `""` to empty array `[]`
  - Course Builder stores this as-is from Content Studio - never modifies or generates it
- **content** (on Exercise): Exercise-specific content (from exercises table, not from Content Studio JSONB)

### 8.2 Derived Fields Calculation
- **Progress**: Calculated from `lesson_completion_dictionary` (completed lessons / total lessons)
- **Completion Rate**: Calculated from `registrations` table (completed / total)
- **Rating**: Calculated from `feedback` table (AVG rating)
- **Skills**: Aggregated from all lessons: `lessons.flatMap(l => l.skills)` (Topics don't store skills - they're structural containers only)
- **Version**: Latest version number from `versions` table

### 8.3 Data Aggregation Strategy
- **Nested Queries**: Topics → Modules → Lessons are fetched separately and aggregated in service layer
- **Single Query with Joins**: Not used (to avoid N+1 queries, repositories fetch in batches)
- **Caching**: Not implemented (could cache course structure for frequently accessed courses)

---

## 9. Frontend Component Mapping

### Component Hierarchy
```
CourseDetailsPage
  ├─ CourseOverview (displays course metadata)
  ├─ CourseStructure (displays modules/lessons)
  └─ EnrollModal (registers learner)

CourseStructurePage
  └─ CourseTreeView (displays full hierarchy)

LessonPage
  ├─ LessonViewer (displays lesson content)
  └─ LessonAssetsPanel (displays enrichment assets)

TrainerDashboard
  └─ TrainerCourses (lists trainer's courses)

LearnerDashboard
  └─ LearnerLibrary (lists enrolled courses)
```

### Data Flow in Frontend
1. **API Call**: `apiService.getCourseById(courseId)`
2. **Data Transformation**: Service returns nested structure (modules → lessons)
3. **Component Rendering**: React components render the hierarchy
4. **User Interaction**: User clicks lesson → navigates to `LessonPage`
5. **Progress Update**: User completes lesson → `apiService.updateCourseProgress()`

---

## 10. Summary

The Course Builder hierarchy follows a strict parent-child relationship:

**Course → Topics → Modules → Lessons → Exercises**

This hierarchy is **always maintained** for both:
- **Personalized courses** (Learner AI → Content Studio → Course Builder)
- **Trainer-created courses** (Content Studio → Course Builder)

### ⚠️ CRITICAL PRINCIPLES:

1. **Content Studio is the ONLY Content Source**:
   - **Course Builder NEVER creates lesson content**
   - **Course Builder NEVER generates educational content**
   - **Course Builder NEVER creates placeholder lessons**
   - All lesson content (content_data, devlab_exercises) comes from Content Studio

2. **Topics and Modules are Structural Containers ONLY**:
   - Topics and Modules contain NO actual content - EVER
   - They exist ONLY to maintain the hierarchy structure
   - They provide grouping and navigation in the UI
   - All real content lives at the **Lesson** level

3. **Consistent Hierarchy**: 
   - Course → Topics → Modules → Lessons → Exercises is always maintained
   - Structure is identical for Trainer and Personalized courses
   - Topics and Modules serve as **structural/grouping containers only**
   - Actual learning content always lives at the **Lesson** level

4. **Content Studio Mapping**:
   - One Content Studio `topic` = one Course Builder `lesson`
   - Content Studio `contents[]` array → stored in `lesson.content_data` (JSONB array)
   - Content Studio `devlab_exercises` → stored in `lesson.devlab_exercises` (JSONB array)
   - Topics and Modules are created as structural containers (grouping/navigation only, NO CONTENT)

5. **Course Builder Role**:
   - **Course Builder is a structuring orchestrator**
   - It organizes content from Content Studio into the hierarchy
   - It never invents or generates content
   - It extracts metadata and forwards context to Content Studio for personalized courses

6. **Field Characteristics**:
   - **Mandatory fields** ensure data integrity
   - **Optional fields** provide flexibility
   - **JSONB fields** store complex nested data without separate tables
   - **Derived fields** are calculated on-the-fly for performance
   - **Cascade deletes** maintain referential integrity

7. **External Service Integration**:
   - Learning Analytics depends on complete hierarchy for analytics
   - Content Studio provides ALL lesson content (stored in `lesson.content_data`)
   - Assessment depends on lesson hierarchy for coverage maps
   - Learner AI provides metadata/context for personalized courses

The hierarchy is optimized for:
- **Read operations**: Fast queries with indexes
- **Write operations**: Efficient updates with JSONB fields
- **Scalability**: Horizontal scaling with stateless services
- **Flexibility**: JSONB fields allow schema evolution without migrations

