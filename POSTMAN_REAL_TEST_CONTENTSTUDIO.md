# Real Postman Test: AI-Powered Query Builder with ContentStudio Contract

This guide provides **real, working examples** using actual ContentStudio contract structure and database schema.

## Real Test Example 1: Get Course Data for ContentStudio Response

### Setup in Postman

**Method**: `POST`  
**URL**: `http://localhost:3000/api/fill-content-metrics`

**Headers**:
```
Content-Type: application/json
```

**Body** (raw JSON):
```json
{
  "requester_service": "CourseBuilder",
  "payload": "{\"course_id\": \"d0e1f2a3-b4c5-6789-ef01-890123456789\"}",
  "response": "{\"course_id\": \"\", \"course_name\": \"\", \"course_description\": \"\", \"trainer_id\": \"\", \"trainer_name\": \"\", \"topic_id\": \"\", \"topic_name\": \"\", \"topic_description\": \"\", \"skills\": [], \"content_type\": \"\", \"total_lessons\": 0}"
}
```

**What This Does**:
- Uses a real course ID from your database (seed data course)
- Requests fields matching ContentStudio contract structure
- AI will generate SQL to fetch: course_name, course_description, created_by_user_id (trainer_id), topic data, skills, etc.

**Expected Response** (after AI fills template):
```json
{
  "requester_service": "CourseBuilder",
  "payload": "{\"course_id\": \"d0e1f2a3-b4c5-6789-ef01-890123456789\"}",
  "response": "{\"course_id\": \"d0e1f2a3-b4c5-6789-ef01-890123456789\", \"course_name\": \"Advanced JavaScript and React\", \"course_description\": \"Master advanced JavaScript concepts...\", \"trainer_id\": \"20000000-0000-0000-0000-000000000001\", \"trainer_name\": \"\", \"topic_id\": \"...\", \"topic_name\": \"...\", \"topic_description\": \"...\", \"skills\": [\"javascript\", \"react\"], \"content_type\": \"mixed\", \"total_lessons\": 12}"
}
```

---

## Real Test Example 2: Get Course Metrics for ContentStudio

### Postman Request

**Method**: `POST`  
**URL**: `http://localhost:3000/api/fill-content-metrics`

**Body**:
```json
{
  "requester_service": "CourseBuilder",
  "payload": "{\"course_id\": \"d0e1f2a3-b4c5-6789-ef01-890123456789\"}",
  "response": "{\"course_id\": \"\", \"course_name\": \"\", \"total_topics\": 0, \"total_modules\": 0, \"total_lessons\": 0, \"average_rating\": 0, \"total_enrollments\": 0}"
}
```

**Expected SQL Generated by AI**:
```sql
SELECT 
  c.id AS course_id,
  c.course_name,
  COUNT(DISTINCT t.id) AS total_topics,
  COUNT(DISTINCT m.id) AS total_modules,
  COUNT(DISTINCT l.id) AS total_lessons,
  AVG(f.rating) AS average_rating,
  COUNT(DISTINCT r.learner_id) AS total_enrollments
FROM courses c
LEFT JOIN topics t ON t.course_id = c.id
LEFT JOIN modules m ON m.topic_id = t.id
LEFT JOIN lessons l ON l.module_id = m.id
LEFT JOIN feedback f ON f.course_id = c.id
LEFT JOIN registrations r ON r.course_id = c.id
WHERE c.id = $1
GROUP BY c.id, c.course_name
```

**Expected Response**:
```json
{
  "requester_service": "CourseBuilder",
  "payload": "{\"course_id\": \"d0e1f2a3-b4c5-6789-ef01-890123456789\"}",
  "response": "{\"course_id\": \"d0e1f2a3-b4c5-6789-ef01-890123456789\", \"course_name\": \"Advanced JavaScript and React\", \"total_topics\": 3, \"total_modules\": 5, \"total_lessons\": 12, \"average_rating\": 4.5, \"total_enrollments\": 25}"
}
```

---

## Real Test Example 3: Get Topic Data (ContentStudio Structure)

### Postman Request

**Body**:
```json
{
  "requester_service": "CourseBuilder",
  "payload": "{\"course_id\": \"d0e1f2a3-b4c5-6789-ef01-890123456789\", \"topic_id\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\"}",
  "response": "{\"topic_id\": \"\", \"topic_name\": \"\", \"topic_description\": \"\", \"skills\": [], \"lessons_count\": 0, \"modules_count\": 0}"
}
```

**Expected Response**:
```json
{
  "requester_service": "CourseBuilder",
  "payload": "{\"course_id\": \"d0e1f2a3-b4c5-6789-ef01-890123456789\", \"topic_id\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\"}",
  "response": "{\"topic_id\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\", \"topic_name\": \"React Fundamentals\", \"topic_description\": \"Learn React basics\", \"skills\": [\"react\", \"jsx\", \"components\"], \"lessons_count\": 5, \"modules_count\": 2}"
}
```

---

## Real Test Example 4: Get Trainer Course Data (Full ContentStudio Response)

### Postman Request

**Body**:
```json
{
  "requester_service": "CourseBuilder",
  "payload": "{\"course_id\": \"d0e1f2a3-b4c5-6789-ef01-890123456789\"}",
  "response": "{\"trainer_course\": {\"course_id\": \"\", \"course_name\": \"\", \"course_description\": \"\", \"trainer_id\": \"\", \"trainer_name\": \"\", \"topic_id\": \"\", \"topic_name\": \"\", \"topic_description\": \"\", \"skills\": [], \"content_type\": \"\", \"devlab_exercises\": []}}"
}
```

**Expected Response** (matching ContentStudio contract):
```json
{
  "requester_service": "CourseBuilder",
  "payload": "{\"course_id\": \"d0e1f2a3-b4c5-6789-ef01-890123456789\"}",
  "response": "{\"trainer_course\": {\"course_id\": \"d0e1f2a3-b4c5-6789-ef01-890123456789\", \"course_name\": \"Advanced JavaScript and React\", \"course_description\": \"Master advanced JavaScript concepts...\", \"trainer_id\": \"20000000-0000-0000-0000-000000000001\", \"trainer_name\": \"\", \"topic_id\": \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\", \"topic_name\": \"React Fundamentals\", \"topic_description\": \"Learn React basics\", \"skills\": [\"react\", \"javascript\"], \"content_type\": \"mixed\", \"devlab_exercises\": []}}"
}
```

---

## How to Get Real Course IDs from Your Database

### Option 1: Query Database Directly

Connect to your PostgreSQL database and run:

```sql
-- Get all course IDs with names
SELECT id, course_name, course_type, status 
FROM courses 
ORDER BY created_at DESC 
LIMIT 10;

-- Example result:
-- id: d0e1f2a3-b4c5-6789-ef01-890123456789
-- course_name: Advanced JavaScript and React
-- course_type: trainer
-- status: active
```

### Option 2: Use the Courses API First

1. In Postman, create a GET request:
   - **Method**: `GET`
   - **URL**: `http://localhost:3000/api/v1/courses`

2. Send request and get response:
```json
{
  "courses": [
    {
      "id": "d0e1f2a3-b4c5-6789-ef01-890123456789",
      "course_name": "Advanced JavaScript and React",
      ...
    }
  ]
}
```

3. Copy a `course_id` from the response

4. Use it in your `/api/fill-content-metrics` request

---

## Real Database Field Mappings

Based on the actual database schema and ContentStudio contract:

| ContentStudio Field | Database Source | SQL Field |
|---------------------|-----------------|-----------|
| `course_id` | `courses.id` | `c.id` |
| `course_name` | `courses.course_name` | `c.course_name` |
| `course_description` | `courses.course_description` | `c.course_description` |
| `trainer_id` | `courses.created_by_user_id` | `c.created_by_user_id` |
| `topic_id` | `topics.id` | `t.id` |
| `topic_name` | `topics.topic_name` | `t.topic_name` |
| `topic_description` | `topics.topic_description` | `t.topic_description` |
| `skills` | `topics.skills` or `lessons.skills` (JSONB array) | `t.skills` or `l.skills` |
| `content_type` | `lessons.content_type` | `l.content_type` |
| `content_data` | `lessons.content_data` (JSONB) | `l.content_data` |
| `devlab_exercises` | `lessons.devlab_exercises` (JSONB array) | `l.devlab_exercises` |

**Aggregations**:
- `total_lessons`: `COUNT(DISTINCT lessons.id)`
- `total_modules`: `COUNT(DISTINCT modules.id)`
- `total_topics`: `COUNT(DISTINCT topics.id)`
- `average_rating`: `AVG(feedback.rating)`
- `total_enrollments`: `COUNT(DISTINCT registrations.learner_id)`

---

## Testing Checklist

### Before Testing:
- [ ] Server is running (`npm start` in backend/)
- [ ] Database is accessible
- [ ] Environment variables set (`GEMINI_API_KEY`, `DATABASE_URL`)
- [ ] Seed data loaded (run `node backend/scripts/seedMockData.js`)

### During Testing:
- [ ] Check server logs for AI-generated SQL
- [ ] Verify SQL is SELECT-only (security check)
- [ ] Check query parameters are extracted correctly
- [ ] Verify query executes successfully
- [ ] Confirm template fills with real values

### After Testing:
- [ ] Response status is `200 OK`
- [ ] Response format matches expected structure
- [ ] Values are filled (not zeros/empty strings)
- [ ] Database field names map correctly to template fields
- [ ] ContentStudio contract structure is preserved

---

## Example Real Course IDs (from Seed Data)

If you've run the seed script, these course IDs should exist:

### Marketplace Courses (Trainer):
- `d0e1f2a3-b4c5-6789-ef01-890123456789` - "Advanced JavaScript and React"
- `e1f2a3b4-c5d6-7890-ef01-89012345678a` - "Python Data Science"
- `f2a3b4c5-d6e7-8901-ef01-89012345678b` - "Node.js Backend Development"

### Personalized Courses (Learner):
- `b8c9d0e1-f2a3-4567-cdef-678901234567` - "Personalized JavaScript Course"
- `c9d0e1f2-a3b4-5678-cdef-678901234568` - "Custom Python Path"

**Trainer ID** (from seed data):
- `20000000-0000-0000-0000-000000000001`

**Learner ID** (from seed data):
- `10000000-0000-0000-0000-000000000001`

---

## Server Logs to Watch For

When you send the Postman request, watch your server console for:

```
[Fill Content Metrics] Generating SQL query...
[Fill Content Metrics] Generated SQL: SELECT c.id AS course_id, c.course_name, ...
[Fill Content Metrics] Query params: ['d0e1f2a3-b4c5-6789-ef01-890123456789']
[Fill Content Metrics] Executing query...
[Fill Content Metrics] Query results: { course_id: '...', course_name: '...', ... }
[Fill Content Metrics] Filling template...
[Fill Content Metrics] Filled template: { course_id: '...', course_name: '...', ... }
```

---

## Troubleshooting

### Error: "relation 'courses' does not exist"
**Fix**: Run database migrations:
```bash
node backend/scripts/setup-database.js
```

### Error: No rows returned
**Fix**: Seed the database:
```bash
node backend/scripts/seedMockData.js
```

### Error: Invalid course_id
**Fix**: Get a real course ID from database:
```sql
SELECT id FROM courses LIMIT 1;
```

### Error: AI generated wrong SQL
**Fix**: Check AI prompt - it should understand the database schema. Review server logs for the generated SQL.

---

## Next Steps

1. Test with real course IDs from your database
2. Try different ContentStudio contract fields
3. Test nested structures (trainer_course object)
4. Test aggregations (total_lessons, average_rating)
5. Monitor AI query generation time
6. Verify all ContentStudio contract fields map correctly

**Ready to test! Use the examples above with real course IDs from your database.** ðŸš€

