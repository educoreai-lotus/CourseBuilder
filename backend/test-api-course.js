/**
 * Test script to create a course via API and verify AI structure
 * 
 * Usage:
 *   node test-api-course.js
 */

import axios from 'axios';
import db, { pgp } from './config/database.js';
import dotenv from 'dotenv';

dotenv.config();

const API_URL = process.env.API_URL || 'http://localhost:3000';

async function testAICourseCreation() {
  console.log('\n' + '='.repeat(70));
  console.log('üöÄ TESTING AI COURSE CREATION');
  console.log('='.repeat(70) + '\n');

  const courseData = {
    learner_id: '10000000-0000-0000-0000-000000000001',
    learner_name: 'Alice Learner',
    learner_company: 'Emerald Learning',
    learning_path: [
      {
        topic_name: 'JavaScript Fundamentals',
        topic_description: 'Learn JavaScript basics and core concepts'
      },
      {
        topic_name: 'React Development',
        topic_description: 'Build modern React applications'
      }
    ],
    skills: ['javascript', 'react', 'frontend'],
    level: 'beginner',
    duration: 10,
    metadata: {
      learner_id: '10000000-0000-0000-0000-000000000001',
      learner_company: 'Emerald Learning'
    },
    sourceService: 'test-script'
  };

  try {
    console.log('üì° Sending request to API...');
    console.log(`   URL: ${API_URL}/api/v1/courses/input\n`);

    const response = await axios.post(`${API_URL}/api/v1/courses/input`, courseData, {
      headers: {
        'Content-Type': 'application/json',
        'x-service-name': 'test-script',
        'x-role': 'service',
        'x-user-role': 'service'
      }
    });

    console.log('‚úÖ Course created successfully!\n');
    console.log('üìã Response:');
    console.log(JSON.stringify(response.data, null, 2));
    console.log('');

    const courseId = response.data.course_id;
    const structure = response.data.structure;

    console.log('='.repeat(70));
    console.log('ü§ñ AI STRUCTURE INFORMATION');
    console.log('='.repeat(70) + '\n');

    if (structure) {
      console.log('üìä Structure Summary:');
      console.log(`   Topics: ${structure.topics}`);
      console.log(`   Modules: ${structure.modules}`);
      console.log(`   Lessons: ${structure.lessons}`);
      console.log(`   Structure Source: ${structure.structureSource || structure.structureSource}`);
      
      if (structure.structureSource === 'ai-generated') {
        console.log('\n‚úÖ AI successfully generated the structure!');
      } else {
        console.log('\n‚ö†Ô∏è  AI was not used (fallback structure)');
      }
    }

    // Check database directly
    console.log('\n' + '='.repeat(70));
    console.log('üîç VERIFYING IN DATABASE');
    console.log('='.repeat(70) + '\n');

    const course = await db.one(
      `SELECT 
        id,
        course_name,
        learning_path_designation
      FROM courses
      WHERE id = $1`,
      [courseId]
    );

    const metadata = course.learning_path_designation || {};

    console.log(`üìö Course: ${course.course_name}`);
    console.log(`   ID: ${course.id}\n`);
    console.log('ü§ñ AI Status:');
    console.log(`   Source: ${metadata.structure_source || 'unknown'}`);
    console.log(`   Generated By: ${metadata.structure_generated_by || 'unknown'}`);
    console.log(`   Generated At: ${metadata.generated_at || 'N/A'}\n`);

    if (metadata.structure_source === 'ai-generated' && metadata.structure_generated_by === 'ai') {
      console.log('‚úÖ AI SUCCESSFULLY GENERATED STRUCTURE');
    } else if (metadata.structure_source === 'fallback') {
      console.log('‚ö†Ô∏è  FALLBACK STRUCTURE (AI not used)');
    } else {
      console.log('‚ùì UNKNOWN (metadata not set)');
    }

    // Get topics
    const topics = await db.any(
      `SELECT 
        t.topic_name,
        COUNT(DISTINCT m.id) as modules,
        COUNT(DISTINCT l.id) as lessons
      FROM topics t
      LEFT JOIN modules m ON m.topic_id = t.id
      LEFT JOIN lessons l ON l.module_id = m.id
      WHERE t.course_id = $1
      GROUP BY t.id, t.topic_name
      ORDER BY t.topic_name`,
      [courseId]
    );

    if (topics.length > 0) {
      console.log('\nüìñ Topics Created:');
      topics.forEach((topic, idx) => {
        console.log(`   ${idx + 1}. ${topic.topic_name} (${topic.modules} modules, ${topic.lessons} lessons)`);
      });
    }

    console.log('\nüéâ Test completed!\n');

  } catch (error) {
    console.error('\n‚ùå Error creating course:');
    
    if (error.response) {
      console.error(`   Status: ${error.response.status}`);
      console.error(`   Message: ${error.response.data?.message || error.message}`);
      if (error.response.data) {
        console.error(`   Details:`, JSON.stringify(error.response.data, null, 2));
      }
    } else if (error.request) {
      console.error('   Network error - is the server running?');
      console.error(`   URL: ${API_URL}/api/v1/courses/input`);
    } else {
      console.error(`   ${error.message}`);
    }

    console.error('\nüí° Make sure:');
    console.error('   1. Backend server is running (npm run dev)');
    console.error('   2. Server is accessible at', API_URL);
    console.error('   3. OpenAI API key is set in .env file');
    console.error('');

    process.exit(1);
  } finally {
    await pgp.end();
  }
}

testAICourseCreation();
