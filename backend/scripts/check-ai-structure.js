/**
 * Check if AI was used to generate course structure
 * 
 * Usage:
 *   node scripts/check-ai-structure.js <course-id>
 * 
 * Or check all courses:
 *   node scripts/check-ai-structure.js
 */

import db, { pgp } from '../config/database.js';
import dotenv from 'dotenv';

dotenv.config();

async function checkAIStructure(courseId = null) {
  try {
    let courses;
    
    if (courseId) {
      // Check specific course
      courses = await db.any(
        `SELECT 
          id,
          course_name,
          course_type,
          learning_path_designation
        FROM courses
        WHERE id = $1`,
        [courseId]
      );
      
      if (courses.length === 0) {
        console.error(`‚ùå Course with ID ${courseId} not found`);
        process.exit(1);
      }
    } else {
      // Check all courses
      courses = await db.any(
        `SELECT 
          id,
          course_name,
          course_type,
          learning_path_designation
        FROM courses
        ORDER BY created_at DESC
        LIMIT 20`
      );
    }

    console.log('\n' + '='.repeat(70));
    console.log('ü§ñ AI STRUCTURE VERIFICATION');
    console.log('='.repeat(70) + '\n');

    for (const course of courses) {
      const metadata = course.learning_path_designation || {};
      
      console.log(`üìö Course: ${course.course_name}`);
      console.log(`   ID: ${course.id}`);
      console.log(`   Type: ${course.course_type}`);
      
      // Check AI status
      const structureSource = metadata.structure_source || 'unknown';
      const generatedBy = metadata.structure_generated_by || 'unknown';
      const generatedAt = metadata.generated_at || 'unknown';
      
      console.log(`\n   ü§ñ AI Status:`);
      console.log(`      Source: ${structureSource}`);
      console.log(`      Generated By: ${generatedBy}`);
      console.log(`      Generated At: ${generatedAt || 'N/A'}`);
      
      // Status indicator
      if (structureSource === 'ai-generated' && generatedBy === 'ai') {
        console.log(`      ‚úÖ AI SUCCESSFULLY GENERATED STRUCTURE`);
      } else if (structureSource === 'fallback') {
        console.log(`      ‚ö†Ô∏è  FALLBACK STRUCTURE (AI not used)`);
      } else {
        console.log(`      ‚ùì UNKNOWN (may be old course or manual creation)`);
      }
      
      // Structure summary
      console.log(`\n   üìä Structure Summary:`);
      console.log(`      Topics: ${metadata.total_topics || 0}`);
      console.log(`      Modules: ${metadata.total_modules || 0}`);
      console.log(`      Lessons: ${metadata.total_lessons || 0}`);
      
      // Get actual topics
      const topics = await db.any(
        `SELECT 
          t.topic_name,
          t.topic_description,
          COUNT(DISTINCT m.id) as module_count,
          COUNT(DISTINCT l.id) as lesson_count
        FROM topics t
        LEFT JOIN modules m ON m.topic_id = t.id
        LEFT JOIN lessons l ON l.module_id = m.id
        WHERE t.course_id = $1
        GROUP BY t.id, t.topic_name, t.topic_description
        ORDER BY t.topic_name`,
        [course.id]
      );
      
      if (topics.length > 0) {
        console.log(`\n   üìñ Topics Created:`);
        topics.forEach((topic, idx) => {
          const isGeneric = /^topic\s*\d+$/i.test(topic.topic_name.trim());
          const indicator = isGeneric ? '‚ö†Ô∏è' : '‚úÖ';
          console.log(`      ${indicator} ${idx + 1}. ${topic.topic_name}`);
          if (topic.topic_description) {
            console.log(`         ${topic.topic_description}`);
          }
          console.log(`         (${topic.module_count} modules, ${topic.lesson_count} lessons)`);
        });
        
        // Check if names look AI-generated
        const genericNames = topics.filter(t => /^topic\s*\d+$/i.test(t.topic_name.trim()));
        if (genericNames.length > 0 && structureSource === 'ai-generated') {
          console.log(`\n   ‚ö†Ô∏è  WARNING: Some topic names look generic despite AI generation`);
        }
      } else {
        console.log(`\n   ‚ö†Ô∏è  No topics found for this course`);
      }
      
      console.log('\n' + '-'.repeat(70) + '\n');
    }
    
    // Summary
    const aiGenerated = courses.filter(c => {
      const meta = c.learning_path_designation || {};
      return meta.structure_source === 'ai-generated' && meta.structure_generated_by === 'ai';
    }).length;
    
    const fallback = courses.filter(c => {
      const meta = c.learning_path_designation || {};
      return meta.structure_source === 'fallback';
    }).length;
    
    console.log('üìä SUMMARY:');
    console.log(`   Total courses checked: ${courses.length}`);
    console.log(`   ‚úÖ AI-generated: ${aiGenerated}`);
    console.log(`   ‚ö†Ô∏è  Fallback: ${fallback}`);
    console.log(`   ‚ùì Unknown/Other: ${courses.length - aiGenerated - fallback}`);
    console.log('\n');
    
  } catch (error) {
    console.error('‚ùå Error:', error.message);
    console.error(error.stack);
    process.exit(1);
  } finally {
    await pgp.end();
  }
}

// Get course ID from command line
const courseId = process.argv[2];

if (courseId && courseId.length < 10) {
  console.error('‚ùå Invalid course ID. Course IDs are UUIDs (36 characters)');
  console.error('Usage: node scripts/check-ai-structure.js [course-id]');
  process.exit(1);
}

checkAIStructure(courseId);
